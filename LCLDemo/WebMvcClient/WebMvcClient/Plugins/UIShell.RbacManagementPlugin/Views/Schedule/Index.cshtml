@using LCL.MvcExtensions;
@{
    ViewBag.Title = "计划任务列表";
}
<!--   数据列表    -->
<table id="grid" title="计划任务列表" class="easyui-datagrid" toolbar="#toolbar"></table>
<!--   命令列表   -->
<div id="toolbar">
    <a href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-add" plain="true" onclick="add()" />添加
    <a href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-remove" plain="true" onclick="del()" />删除
    <a href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-reload" plain="true" onclick="refresh()" />刷新
    <a href="javascript:void(0)" />
</div>
<!--   弹出框       -->
<div id="dlg" class="easyui-dialog" style="width: 500px; height: 280px; padding: 1px 1px;" closed="true" buttons="#dlg-buttons">

</div>
@section scripts{
    <script type="text/javascript">
        $(document).ready(function () {
            $('#grid').datagrid({
                url: 'AjaxGetBy',
                loadMsg: '数据加载中....',
                title: '计划任务信息一览表',
                iconCls: 'icon-edit',
                pagination: true,
                rownumbers: true,
                fitCloumns: true,
                hideColumn: [[
                  { title: '编号', field: 'ID' }
                ]],
                columns: [[
                    { field: 'ck', checkbox: true },
                    { field: 'Exetime', title: '计划任务名称', width: 200 },
                    { field: 'Exetime', title: '执行方式', width: 500 },
                    { field: 'Lastexecuted', title: '上次执行时间', width: 150 },
                    {
                        field: 'Enable', title: '状态', width: 150,
                        formatter: function (value, row, index) {
                            if (value) {
                                return '开启';
                            } else {
                                return '关闭';
                            }
                        }
                    },
                    {
                        field: 'Issystemevent', title: '级别', width: 150,
                        formatter: function (value, row, index) {
                            if (value) {
                                return '系统级';
                            } else {
                                return '非系统级';
                            }
                        }
                    },
                    {
                        field: 'opt', title: '操作', width: 100, align: 'center',
                        formatter: function (value, rec) {
                            return "<a href='javascript:void(0)' class='easyui-linkbutton' iconcls='icon-man' plain='true' onclick='ExecCommand()'>立即执行</a>  "
                                + "<a href='javascript:void(0)' class='easyui-linkbutton' iconcls='icon-edit' plain='true' onclick='edit()'>修改 </a>  "
                                + "<a href='javascript:void(0)' class='easyui-linkbutton' iconcls='icon-remove' plain='true' onclick='del()'>删除 </a>    ";
                        }
                    }
                ]]
            });
        });
        function add() {
            var d = $('#dlg').dialog({
                title: '添加',
                width: 500,
                height: 280,
                closed: true,
                cache: false,
                href: 'AddOrEdit',
                iconCls: 'icon-add',
                modal: true,
                onClose: function () {
                    refresh();
                }
            });
            $("#dlg").dialog("open");

        }
        function edit() {
            var row = $("#grid").datagrid("getSelected");
            if (row) {
                $('#dlg').dialog({
                    title: '修改',
                    width: 500,
                    height: 280,
                    closed: true,
                    cache: false,
                    href: 'AddOrEdit?id=' + trim(row.ID),
                    iconCls: 'icon-edit',
                    modal: true,
                    onClose: function () {
                        refresh();
                    }
                });
                $("#dlg").dialog("open");
            }
        }
        function del() {
            var rows = $('#grid').datagrid('getSelections');
            if (!rows || rows.length == 0) {
                $.messager.alert('提示', '请选择要删除的数据!', 'info');
                return;
            }
            var parm;
            $.each(rows, function (i, row) {
                if (i == 0) {
                    parm = "idList=" + row.ID;
                } else {
                    parm += "&idList=" + row.ID;
                }
            });
            $.messager.confirm('提示', '是否删除选中数据?', function (r) {
                if (!r) {
                    return;
                }
                //提交
                $.post('AjaxDeleteList/', parm,
                function (msg) {
                    if (msg.Success) {
                        $.messager.alert('提示', msg.Message, 'info', function () {
                            //重新加载当前页
                            $('#grid').datagrid('reload');
                        });
                    } else {
                        $.messager.alert('提示', msg.Message, 'info')
                    }
                }, "json");
            });
        }
        function ExecCommand() {
            var row = $("#grid").datagrid("getSelected");
            if (row) {
                //提交
                $.post('AjaxExecCommand?key=', row.key,
                function (msg) {
                    if (msg.Success) {
                        $.messager.alert('提示', msg.Message, 'info', function () {
                            //重新加载当前页
                            $('#grid').datagrid('reload');
                        });
                    } else {
                        $.messager.alert('提示', msg.Message, 'info')
                    }
                }, "json");
            }
        }
        function refresh() {
            $('#grid').datagrid('load');
        }
        function trim(str) {
            //FUNCTION:去掉字符串的两边空格,中间的空格保留
            v = str.replace(/(^\s*)|(\s*$)/g, "");
            return v;
        }
    </script>
}
