<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1" />
    <title>Autofac-LCL框架文档</title>
    <link href="css/bootstrap.min.css" rel="stylesheet" type="text/css" />
    <link href="css/lcl.css" rel="stylesheet" type="text/css" />
</head>

<body>
    <div class="navheader">
        <table width="100%" summary="Navigation header">
            <tr>
                <th colspan="3" align="center" style="text-align: center;">Autofac</th>
            </tr>
            <tr>
                <td width="20%" align="left">
                    <a accesskey="p" href="Debugging.html">Prev</a>&nbsp;
                </td>
                <th width="60%" align="center">&nbsp;</th>
                <td width="20%" align="right">
                    &nbsp;
                    <a accesskey="n" href="Logging.html">Next</a>
                </td>
            </tr>
        </table><hr />
    </div>

    <div class="document-contents">
        <h3 id="DocServerSide">Autofac依赖注入分析</h3>
        <p>通过Autofac对接口依赖的实现进行注入，需要用到的核心类如下</p>
        <img src="images/Autofac.png" />
        <p>
            在项目启动的时候初始化引擎上下文

            <pre>
<code class="language-bash" data-lang="bash"> EngineContext.Initialize(false); </code>
</pre>

            在需要IOC的项目中建立DependencyRegistrar，
            其作用就是调用Autofac相关的API进行依赖注入，我们只要打开这个类文件，搜索一个指定的接口，就可以找到它的依赖具体类。
        </p>
        <h3 id="DocServerSide">注入</h3>
        <p></p>
        <pre>
          
public partial interface IRoleService
{
}
public partial class RoleService : IRoleService
{
}
public class DependencyRegistrar : IDependencyRegistrar
{
        public virtual void Register(ContainerBuilder builder, ITypeFinder typeFinder)
        {
            //data layer
            var dbset = DbSetting.FindOrCreate("LCL");     
            builder.Register(x => new EfDataProviderManager(dbset)).As&lt;BaseDataProviderManager&gt;().InstancePerDependency();
            builder.Register(x => x.Resolve&lt;BaseDataProviderManager&gt;().LoadDataProvider()).As&lt;IDataProvider&gt;().InstancePerDependency();
            var efDataProviderManager = new EfDataProviderManager(dbset);
            var dataProvider = efDataProviderManager.LoadDataProvider();
            dataProvider.InitConnectionFactory();
            builder.Register&lt;IEfDbContext>(c => new RbacDbContext(dbset.ConnectionString)).Named&lt;IEfDbContext&gt;(dbset.Name).InstancePerLifetimeScope();
            //Repositories  
            builder.RegisterGeneric(typeof(EfRepository<>)).As(typeof(IRepository<>))
.WithParameter(ResolvedParameter.ForNamed&lt;IEfDbContext&gt;(dbset.name)).instanceperlifetimescope();
            //services 
            builder.RegisterType&lt;RoleService&gt;().As&lt;IRoleService&gt;().WithParameter(ResolvedParameter.ForNamed&lt;IEfDbContext&gt;(dbset.Name))
                .InstancePerLifetimeScope(); 
        }
        public int Order
        {
            get { return 5; }
        }
}
    
</pre>
    </div>

    <div class="navfooter">
        <hr /><table width="100%" summary="Navigation footer">
            <tr>
                <td width="40%" align="left"><a accesskey="p" href="Debugging.html">Prev</a>&nbsp;</td>
                <td width="20%" align="center"><a accesskey="h" href="index.html">Home</a>&nbsp;</td>
                <td width="40%" align="right"><a accesskey="n" href="Logging.html">Next</a>&nbsp;</td>
            </tr>
        </table>
    </div>
</body>
</html>
